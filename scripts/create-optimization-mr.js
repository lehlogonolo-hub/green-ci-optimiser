#!/usr/bin/env node

require('dotenv').config();
const GitLabClient = require('../src/utils/gitlab-client');
const { buildPatch } = require('../src/optimizer/patch-builder');
const logger = require('../src/utils/logger');

async function main() {
  try {
    const optimizationData = JSON.parse(process.env.OPTIMIZATION_DATA);
    const projectId = process.env.CI_PROJECT_ID;
    const gitlabToken = process.env.GITLAB_TOKEN;

    const client = new GitLabClient(gitlabToken);
    const branchName = `green-ci/opt-${Date.now()}`;

    // Create branch
    logger.info(`Creating branch ${branchName}`);
    await client.createBranch(projectId, branchName);

    // Apply optimizations
    for (const opt of optimizationData) {
      const patch = buildPatch(opt);
      await client.commitFile(
        projectId,
        branchName,
        opt.filePath,
        patch.content,
        `Green CI: ${opt.title}\n\n${opt.description}`
      );
    }

    // Create merge request
    const mr = await client.createMergeRequest(projectId, {
      sourceBranch: branchName,
      title: `[Green CI] ${optimizationData.length} optimizations detected`,
      description: generateMRDescription(optimizationData)
    });

    logger.info(`Created MR !${mr.iid}: ${mr.web_url}`);
    console.log(JSON.stringify({ mr_iid: mr.iid, mr_url: mr.web_url }));

  } catch (error) {
    logger.error('MR creation failed', { error: error.message });
    process.exit(1);
  }
}

function generateMRDescription(optimizations) {
  return `## ðŸŒ± Green CI Optimization Report

This merge request was automatically created by the Green CI Optimizer agent.

### ðŸŽ¯ Optimizations Included
${optimizations.map(opt => `
#### ${opt.title}
- **Impact:** ${opt.impact}
- **Estimated COâ‚‚ Savings:** ${opt.estimatedSavingsCo2} kg/run
- **Description:** ${opt.description}

\`\`\`yaml
${opt.patch}
\`\`\`
`).join('\n')}

### ðŸ“Š Expected Impact
- Total COâ‚‚ Reduction: ${optimizations.reduce((sum, opt) => sum + opt.estimatedSavingsCo2, 0).toFixed(4)} kg/run
- Estimated Annual Savings: ${(optimizations.reduce((sum, opt) => sum + opt.estimatedSavingsCo2, 0) * 365).toFixed(2)} kg COâ‚‚

---
ðŸ¤– Generated by [Green CI Optimizer](https://gitlab.com/green-ci-optimizer)`;
}

main();