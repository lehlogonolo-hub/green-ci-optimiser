<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green CI Optimizer - API Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
            color: #1e293b;
        }
        h1 {
            color: #0f172a;
            border-bottom: 3px solid #10b981;
            padding-bottom: 10px;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        .card h3 {
            margin-top: 0;
            color: #0f172a;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h3 .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 999px;
            background: #10b981;
            color: white;
        }
        pre {
            background: #1e293b;
            color: #a5f3fc;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 12px;
            margin: 10px 0;
        }
        button {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            margin-right: 10px;
        }
        button:hover {
            background: #059669;
        }
        button.secondary {
            background: #64748b;
        }
        button.secondary:hover {
            background: #475569;
        }
        .error {
            color: #ef4444;
            font-size: 14px;
            margin-top: 10px;
        }
        .success {
            color: #10b981;
            font-size: 14px;
            margin-top: 10px;
        }
        .api-key-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            margin-bottom: 15px;
            font-family: monospace;
        }
        .header {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 600;
            background: #e2e8f0;
            color: #334155;
        }
    </style>
</head>
<body>
    <h1>üå± Green CI Optimizer - API Test Dashboard</h1>
    
    <div class="header">
        <h3>üîë API Authentication</h3>
        <input type="text" id="apiKey" class="api-key-input" placeholder="Enter API Key" value="demo-key-123">
        <div>
            <span class="badge">Default: demo-key-123</span>
            <span class="badge">Test: test-key-456</span>
        </div>
    </div>

    <div class="container">
        <!-- Health Check Card -->
        <div class="card">
            <h3>
                üè• Health Check
                <span class="status" id="healthStatus">Unknown</span>
            </h3>
            <button onclick="testHealth()">Check Health</button>
            <button class="secondary" onclick="clearOutput('healthOutput')">Clear</button>
            <pre id="healthOutput">Click button to test...</pre>
        </div>

        <!-- Metrics Card -->
        <div class="card">
            <h3>
                üìä Metrics API
                <span class="status" id="metricsStatus">Unknown</span>
            </h3>
            <button onclick="testMetrics()">Get All Metrics</button>
            <button onclick="testMetricsSummary()">Get Summary</button>
            <button class="secondary" onclick="clearOutput('metricsOutput')">Clear</button>
            <pre id="metricsOutput">Click button to test...</pre>
        </div>

        <!-- Optimizations Card -->
        <div class="card">
            <h3>
                ‚ö° Optimizations API
                <span class="status" id="optimizationsStatus">Unknown</span>
            </h3>
            <button onclick="testOptimizations()">Get All</button>
            <button onclick="testCreateOptimization()">Create Test</button>
            <button class="secondary" onclick="clearOutput('optimizationsOutput')">Clear</button>
            <pre id="optimizationsOutput">Click button to test...</pre>
        </div>

        <!-- Agents Card -->
        <div class="card">
            <h3>
                ü§ñ Agents API
                <span class="status" id="agentsStatus">Unknown</span>
            </h3>
            <button onclick="testAgents()">Get All Agents</button>
            <button onclick="testAgentStatus()">Check Optimizer</button>
            <button class="secondary" onclick="clearOutput('agentsOutput')">Clear</button>
            <pre id="agentsOutput">Click button to test...</pre>
        </div>
    </div>

    <div class="container" style="margin-top: 20px;">
        <!-- Create MR Simulation -->
        <div class="card">
            <h3>üîÑ Create Optimization MR</h3>
            <select id="optimizationSelect">
                <option value="opt-1">Enable Dependency Caching</option>
                <option value="opt-2">Consolidate Test Jobs</option>
                <option value="opt-3">Use Alpine Images</option>
            </select>
            <button onclick="applyOptimization()" style="margin-top: 10px;">Apply & Create MR</button>
            <pre id="applyOutput">Select an optimization and click apply...</pre>
        </div>

        <!-- Carbon Predictor -->
        <div class="card">
            <h3>üìà Carbon Predictor</h3>
            <div style="margin-bottom: 10px;">
                <label>Duration Change (minutes):</label>
                <input type="range" id="durationDelta" min="-30" max="30" value="0">
                <span id="durationValue">0</span> min
            </div>
            <div style="margin-bottom: 10px;">
                <label>Job Count Change:</label>
                <input type="range" id="jobDelta" min="-10" max="10" value="0">
                <span id="jobValue">0</span> jobs
            </div>
            <button onclick="predictImpact()">Predict Impact</button>
            <pre id="predictOutput">Adjust sliders and predict...</pre>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001/api';

        function getApiKey() {
            return document.getElementById('apiKey').value;
        }

        async function apiCall(endpoint, options = {}) {
            const headers = {
                'X-API-Key': getApiKey(),
                'Content-Type': 'application/json',
                ...options.headers
            };

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, {
                    ...options,
                    headers
                });
                return await response.json();
            } catch (error) {
                return { error: error.message };
            }
        }

        function updateStatus(elementId, success) {
            const status = document.getElementById(elementId);
            if (status) {
                status.textContent = success ? '‚úì Online' : '‚úó Error';
                status.style.background = success ? '#10b981' : '#ef4444';
            }
        }

        async function testHealth() {
            const output = document.getElementById('healthOutput');
            output.textContent = 'Loading...';
            
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                output.textContent = JSON.stringify(data, null, 2);
                updateStatus('healthStatus', true);
            } catch (error) {
                output.textContent = `Error: ${error.message}`;
                updateStatus('healthStatus', false);
            }
        }

        async function testMetrics() {
            const output = document.getElementById('metricsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/metrics');
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('metricsStatus', !data.error);
        }

        async function testMetricsSummary() {
            const output = document.getElementById('metricsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/metrics/summary');
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('metricsStatus', !data.error);
        }

        async function testOptimizations() {
            const output = document.getElementById('optimizationsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/optimizations');
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('optimizationsStatus', !data.error);
        }

        async function testCreateOptimization() {
            const output = document.getElementById('optimizationsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/optimizations', {
                method: 'POST',
                body: JSON.stringify({
                    title: 'Test Optimization',
                    description: 'This is a test optimization',
                    projectId: 'test-project',
                    impact: 'medium',
                    estimatedSavings: 0.015
                })
            });
            
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('optimizationsStatus', !data.error);
        }

        async function testAgents() {
            const output = document.getElementById('agentsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/agents');
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('agentsStatus', !data.error);
        }

        async function testAgentStatus() {
            const output = document.getElementById('agentsOutput');
            output.textContent = 'Loading...';
            
            const data = await apiCall('/agents/green-ci-optimizer');
            output.textContent = JSON.stringify(data, null, 2);
            updateStatus('agentsStatus', !data.error);
        }

        async function applyOptimization() {
            const select = document.getElementById('optimizationSelect');
            const optId = select.value;
            const output = document.getElementById('applyOutput');
            
            output.textContent = 'Creating Merge Request...';
            
            const data = await apiCall(`/optimizations/${optId}/apply`, {
                method: 'POST'
            });
            
            output.textContent = JSON.stringify(data, null, 2);
        }

        function predictImpact() {
            const durationDelta = document.getElementById('durationDelta').value;
            const jobDelta = document.getElementById('jobDelta').value;
            const output = document.getElementById('predictOutput');
            
            // Simple prediction formula
            const co2PerMin = 0.003;
            const co2PerJob = 0.0015;
            
            const co2Impact = (durationDelta * co2PerMin) + (jobDelta * co2PerJob);
            const energyImpact = co2Impact * 2.1;
            
            output.textContent = JSON.stringify({
                prediction: {
                    co2Delta: Number(co2Impact.toFixed(4)),
                    energyDelta: Number(energyImpact.toFixed(4)),
                    durationDelta: durationDelta,
                    jobDelta: jobDelta,
                    interpretation: co2Impact < 0 ? 
                        '‚úÖ This change would reduce emissions' : 
                        co2Impact > 0 ? 
                        '‚ö†Ô∏è This change would increase emissions' : 
                        'üìä No significant impact'
                },
                annualProjection: {
                    co2Savings: Number((co2Impact * 365).toFixed(2)),
                    treesEquivalent: Math.max(0, Math.round(Math.abs(co2Impact * 365 / 21)))
                }
            }, null, 2);
        }

        function clearOutput(elementId) {
            document.getElementById(elementId).textContent = 'Cleared...';
        }

        // Update range displays
        document.getElementById('durationDelta').addEventListener('input', (e) => {
            document.getElementById('durationValue').textContent = e.target.value;
        });
        
        document.getElementById('jobDelta').addEventListener('input', (e) => {
            document.getElementById('jobValue').textContent = e.target.value;
        });

        // Auto-test health on load
        window.onload = () => {
            testHealth();
        };
    </script>
</body>
</html>